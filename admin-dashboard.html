<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BullBear Trading - Admin Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #0f172a, #1e293b); color: #fff; min-height: 100vh; }
        .conn { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 25px; font-size: 0.9rem; font-weight: 600; z-index: 1000; cursor: pointer; }
        .conn.ok { background: rgba(34,197,94,0.2); color: #22c55e; border: 1px solid #22c55e; }
        .conn.err { background: rgba(239,68,68,0.2); color: #ef4444; border: 1px solid #ef4444; }
        .conn.chk { background: rgba(251,191,36,0.2); color: #fbbf24; border: 1px solid #fbbf24; }
        .login-wrap { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: rgba(255,255,255,0.05); backdrop-filter: blur(20px); border: 1px solid rgba(99,102,241,0.3); border-radius: 20px; padding: 50px; max-width: 450px; width: 100%; }
        .login-box h1 { font-size: 2rem; margin-bottom: 10px; text-align: center; background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .login-box p { color: rgba(255,255,255,0.6); margin-bottom: 30px; text-align: center; }
        .fg { margin-bottom: 25px; }
        .fg label { display: block; margin-bottom: 8px; color: rgba(255,255,255,0.8); font-weight: 500; }
        .fg input { width: 100%; padding: 15px; background: rgba(255,255,255,0.05); border: 1px solid rgba(99,102,241,0.3); border-radius: 10px; color: #fff; font-size: 1rem; }
        .fg input:focus { outline: none; border-color: #6366f1; }
        .lbtn { width: 100%; padding: 15px; background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none; border-radius: 10px; color: #fff; font-size: 1.1rem; font-weight: 600; cursor: pointer; }
        .lbtn:hover { transform: translateY(-2px); box-shadow: 0 10px 30px rgba(99,102,241,0.4); }
        .lbtn:disabled { opacity: 0.6; cursor: not-allowed; }
        .msg { padding: 12px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .msg.show { display: block; }
        .msg.ok { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); color: #22c55e; }
        .msg.err { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); color: #ef4444; }
        .creds { margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); text-align: center; color: rgba(255,255,255,0.5); font-size: 0.9rem; }
        .dash { max-width: 1400px; margin: 0 auto; padding: 20px; display: none; }
        .hdr { background: linear-gradient(135deg, #6366f1, #8b5cf6); padding: 25px 30px; border-radius: 15px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .hdr h1 { font-size: 2rem; }
        .hdr-btns { display: flex; gap: 10px; }
        .rbtn { padding: 10px 20px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; color: #fff; cursor: pointer; font-weight: 600; }
        .rbtn:hover { background: rgba(255,255,255,0.2); }
        .obtn { padding: 10px 20px; background: rgba(239,68,68,0.2); border: 1px solid #ef4444; border-radius: 8px; color: #ef4444; cursor: pointer; font-weight: 600; }
        .obtn:hover { background: #ef4444; color: #fff; }
    </style>
</head>
<body>
    <div id="conn" class="conn chk" onclick="checkConn()">üü° Checking...</div>
    <div id="loginWrap" class="login-wrap">
        <div class="login-box">
            <h1>üîê Admin Access</h1>
            <p>Enter credentials to access dashboard</p>
            <div id="msg" class="msg"></div>
            <form id="loginForm">
                <div class="fg"><label>Email</label><input type="email" id="email" placeholder="admin@bullbeartrading.com" required></div>
                <div class="fg"><label>Password</label><input type="password" id="pass" placeholder="Enter password" required></div>
                <button type="submit" class="lbtn" id="lbtn">Login to Dashboard</button>
            </form>
            <div class="creds"><strong>Credentials:</strong><br>admin@bullbeartrading.com<br>Admin@2025!</div>
        </div>
    </div>
    <div id="dash" class="dash">
        <div class="hdr">
            <div><h1>üéØ Admin Dashboard</h1><p>BullBear Trading Management</p></div>
            <div class="hdr-btns">
                <button class="rbtn" onclick="loadAll()">üîÑ Refresh</button>
                <button class="obtn" onclick="logout()">üö™ Logout</button>
            </div>
        </div>
        <div id="stats"></div>
        <div id="pending"></div>
        <div id="purchases"></div>
        <div id="users"></div>
    </div>
    <div id="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:1000;" onclick="if(event.target===this)closeModal()">
        <div id="modalC" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#1e293b;border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:30px;max-width:500px;width:90%;"></div>
    </div>
    <script>
const API = 'http://localhost:5000/api';
let token = localStorage.getItem('adminToken');
let connected = false;
let allP = [], pendP = [], allU = [];
</script>
</body>
</html>
<script>
// Connection check
async function checkConn() {
    const el = document.getElementById('conn');
    el.className = 'conn chk'; el.textContent = 'üü° Checking...';
    try {
        const r = await fetch(API + '/health');
        if (r.ok) { connected = true; el.className = 'conn ok'; el.textContent = 'üü¢ Connected'; return true; }
        throw new Error();
    } catch { connected = false; el.className = 'conn err'; el.textContent = 'üî¥ Offline'; return false; }
}

// Show message
function showMsg(t, type) {
    const el = document.getElementById('msg');
    el.textContent = t; el.className = 'msg ' + type + ' show';
    if (type === 'ok') setTimeout(() => el.classList.remove('show'), 3000);
}

// Verify token
async function verifyToken() {
    try {
        const r = await fetch(API + '/admin/verify', { headers: { 'Authorization': 'Bearer ' + token } });
        if (r.ok) { showDash(); return true; }
        localStorage.removeItem('adminToken'); token = null;
        return false;
    } catch { localStorage.removeItem('adminToken'); token = null; return false; }
}

// Login
document.getElementById('loginForm').onsubmit = async (e) => {
    e.preventDefault();
    if (!await checkConn()) { showMsg('‚ùå Backend offline. Start server first.', 'err'); return; }
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    const btn = document.getElementById('lbtn');
    btn.disabled = true; btn.textContent = 'Logging in...';
    try {
        const r = await fetch(API + '/admin/login', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, password: pass })
        });
        const d = await r.json();
        if (r.ok) {
            token = d.data.token; localStorage.setItem('adminToken', token);
            showMsg('‚úÖ Success!', 'ok'); btn.textContent = '‚úì Success!';
            setTimeout(showDash, 500);
        } else { showMsg('‚ùå ' + (d.message || 'Invalid credentials'), 'err'); btn.disabled = false; btn.textContent = 'Login to Dashboard'; }
    } catch { showMsg('‚ùå Connection failed', 'err'); btn.disabled = false; btn.textContent = 'Login to Dashboard'; }
};

// Show dashboard
function showDash() {
    document.getElementById('loginWrap').style.display = 'none';
    document.getElementById('dash').style.display = 'block';
    loadAll();
}

// Logout
function logout() { if (confirm('Logout?')) { localStorage.removeItem('adminToken'); token = null; location.reload(); } }

// Load all data
async function loadAll() { await Promise.all([loadStats(), loadPending(), loadPurchases(), loadUsers()]); }
</script>
<script>
// Load stats
async function loadStats() {
    try {
        const r = await fetch(API + '/admin/stats', { headers: { 'Authorization': 'Bearer ' + token } });
        if (r.ok) {
            const d = (await r.json()).data;
            document.getElementById('stats').innerHTML = `
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:30px;">
                    <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;">
                        <div style="color:#94a3b8;font-size:0.85rem;text-transform:uppercase;margin-bottom:10px;">üí∞ Revenue</div>
                        <div style="font-size:2.2rem;font-weight:bold;background:linear-gradient(135deg,#6366f1,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">$${d.totalRevenue||0}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;">
                        <div style="color:#94a3b8;font-size:0.85rem;text-transform:uppercase;margin-bottom:10px;">üë• Users</div>
                        <div style="font-size:2.2rem;font-weight:bold;background:linear-gradient(135deg,#6366f1,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${d.totalUsers||0}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;">
                        <div style="color:#94a3b8;font-size:0.85rem;text-transform:uppercase;margin-bottom:10px;">üõí Purchases</div>
                        <div style="font-size:2.2rem;font-weight:bold;background:linear-gradient(135deg,#6366f1,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${d.totalPurchases||0}</div>
                    </div>
                    <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;">
                        <div style="color:#94a3b8;font-size:0.85rem;text-transform:uppercase;margin-bottom:10px;">‚è≥ Pending</div>
                        <div style="font-size:2.2rem;font-weight:bold;background:linear-gradient(135deg,#6366f1,#06b6d4);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">${d.pendingApprovals||0}</div>
                    </div>
                </div>`;
        }
    } catch (e) { console.error('Stats error:', e); }
}

// Load pending
async function loadPending() {
    try {
        const r = await fetch(API + '/admin/purchases?status=pending', { headers: { 'Authorization': 'Bearer ' + token } });
        if (r.ok) { pendP = (await r.json()).data.purchases || []; renderPending(); }
    } catch { pendP = []; renderPending(); }
}

function renderPending() {
    document.getElementById('pending').innerHTML = `
        <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;margin-bottom:30px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                <h2 style="font-size:1.4rem;">üìã Pending Approvals (${pendP.length})</h2>
                <input type="text" placeholder="Search..." onkeyup="searchPend(this.value)" style="padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:8px;color:#fff;">
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;min-width:600px;">
                    <thead><tr style="background:rgba(99,102,241,0.2);">
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Order</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">User</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Course</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Amount</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Date</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Actions</th>
                    </tr></thead>
                    <tbody id="pendBody">${pendP.length === 0 ? '<tr><td colspan="6" style="padding:30px;text-align:center;color:rgba(255,255,255,0.6);">üéâ No pending approvals!</td></tr>' : pendP.map(p => `
                        <tr style="border-bottom:1px solid rgba(99,102,241,0.2);">
                            <td style="padding:12px;"><strong>${p.orderId||'N/A'}</strong></td>
                            <td style="padding:12px;">${p.user?.firstName||''} ${p.user?.lastName||''}<br><small style="color:#94a3b8">${p.user?.email||p.userEmail||''}</small></td>
                            <td style="padding:12px;">${p.course?.title||'N/A'}</td>
                            <td style="padding:12px;"><strong>$${p.amount||0}</strong></td>
                            <td style="padding:12px;">${new Date(p.createdAt).toLocaleDateString()}</td>
                            <td style="padding:12px;">
                                <button onclick="approve('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#22c55e,#10b981);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">‚úì Approve</button>
                                <button onclick="reject('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">‚úó Reject</button>
                            </td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            </div>
        </div>`;
}

function searchPend(t) {
    const f = pendP.filter(p => (p.orderId||'').toLowerCase().includes(t.toLowerCase()) || (p.user?.email||'').toLowerCase().includes(t.toLowerCase()));
    document.getElementById('pendBody').innerHTML = f.length === 0 ? '<tr><td colspan="6" style="padding:30px;text-align:center;">No results</td></tr>' : f.map(p => `
        <tr style="border-bottom:1px solid rgba(99,102,241,0.2);">
            <td style="padding:12px;"><strong>${p.orderId||'N/A'}</strong></td>
            <td style="padding:12px;">${p.user?.firstName||''} ${p.user?.lastName||''}<br><small style="color:#94a3b8">${p.user?.email||p.userEmail||''}</small></td>
            <td style="padding:12px;">${p.course?.title||'N/A'}</td>
            <td style="padding:12px;"><strong>$${p.amount||0}</strong></td>
            <td style="padding:12px;">${new Date(p.createdAt).toLocaleDateString()}</td>
            <td style="padding:12px;">
                <button onclick="approve('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#22c55e,#10b981);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">‚úì</button>
                <button onclick="reject('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">‚úó</button>
            </td>
        </tr>
    `).join('');
}
</script>
<script>
// Load all purchases
async function loadPurchases() {
    try {
        const r = await fetch(API + '/admin/purchases', { headers: { 'Authorization': 'Bearer ' + token } });
        if (r.ok) { allP = (await r.json()).data.purchases || []; renderPurchases(allP); }
    } catch { allP = []; renderPurchases([]); }
}

function renderPurchases(list) {
    document.getElementById('purchases').innerHTML = `
        <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;margin-bottom:30px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                <h2 style="font-size:1.4rem;">üìä All Purchases (${list.length})</h2>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <select onchange="filterP(this.value)" style="padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:8px;color:#fff;">
                        <option value="all">All Status</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option>
                    </select>
                    <input type="text" placeholder="Search..." onkeyup="searchP(this.value)" style="padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:8px;color:#fff;">
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;min-width:700px;">
                    <thead><tr style="background:rgba(99,102,241,0.2);">
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Order</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">User</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Course</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Amount</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Date</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Status</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Actions</th>
                    </tr></thead>
                    <tbody id="pBody">${list.length === 0 ? '<tr><td colspan="7" style="padding:30px;text-align:center;color:rgba(255,255,255,0.6);">No purchases yet</td></tr>' : list.map(p => pRow(p)).join('')}</tbody>
                </table>
            </div>
        </div>`;
}

function pRow(p) {
    const st = p.status === 'pending' ? 'background:rgba(251,191,36,0.2);color:#fbbf24' : p.status === 'approved' || p.status === 'completed' ? 'background:rgba(34,197,94,0.2);color:#22c55e' : 'background:rgba(239,68,68,0.2);color:#ef4444';
    return `<tr style="border-bottom:1px solid rgba(99,102,241,0.2);">
        <td style="padding:12px;"><strong>${p.orderId||'N/A'}</strong></td>
        <td style="padding:12px;">${p.user?.firstName||''} ${p.user?.lastName||''}<br><small style="color:#94a3b8">${p.user?.email||p.userEmail||''}</small></td>
        <td style="padding:12px;">${p.course?.title||'N/A'}</td>
        <td style="padding:12px;"><strong>$${p.amount||0}</strong></td>
        <td style="padding:12px;">${new Date(p.createdAt).toLocaleDateString()}</td>
        <td style="padding:12px;"><span style="padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:600;${st}">${p.status}</span></td>
        <td style="padding:12px;">
            <button onclick="viewP('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#06b6d4,#0891b2);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">üëÅ</button>
            ${p.status === 'pending' ? `<button onclick="approve('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#22c55e,#10b981);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">‚úì</button><button onclick="reject('${p._id}')" style="padding:6px 12px;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;border-radius:6px;color:#fff;cursor:pointer;margin:2px;">‚úó</button>` : ''}
        </td>
    </tr>`;
}

function filterP(v) { renderPurchases(v === 'all' ? allP : allP.filter(p => p.status === v)); }
function searchP(t) { renderPurchases(allP.filter(p => (p.orderId||'').toLowerCase().includes(t.toLowerCase()) || (p.user?.email||'').toLowerCase().includes(t.toLowerCase()) || (p.course?.title||'').toLowerCase().includes(t.toLowerCase()))); }

// Load users
async function loadUsers() {
    try {
        const r = await fetch(API + '/admin/users', { headers: { 'Authorization': 'Bearer ' + token } });
        if (r.ok) { allU = (await r.json()).data.users || []; renderUsers(allU); }
    } catch { allU = []; renderUsers([]); }
}

function renderUsers(list) {
    document.getElementById('users').innerHTML = `
        <div style="background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:15px;padding:25px;margin-bottom:30px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px;">
                <h2 style="font-size:1.4rem;">üë• Users (${list.length})</h2>
                <div style="display:flex;gap:10px;flex-wrap:wrap;">
                    <select onchange="filterU(this.value)" style="padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:8px;color:#fff;">
                        <option value="all">All Roles</option><option value="user">Users</option><option value="admin">Admins</option>
                    </select>
                    <input type="text" placeholder="Search..." onkeyup="searchU(this.value)" style="padding:8px 15px;background:rgba(255,255,255,0.05);border:1px solid rgba(99,102,241,0.3);border-radius:8px;color:#fff;">
                </div>
            </div>
            <div style="overflow-x:auto;">
                <table style="width:100%;border-collapse:collapse;min-width:600px;">
                    <thead><tr style="background:rgba(99,102,241,0.2);">
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Name</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Email</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Role</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Joined</th>
                        <th style="padding:12px;text-align:left;font-size:0.8rem;">Actions</th>
                    </tr></thead>
                    <tbody id="uBody">${list.length === 0 ? '<tr><td colspan="5" style="padding:30px;text-align:center;color:rgba(255,255,255,0.6);">No users yet</td></tr>' : list.map(u => uRow(u)).join('')}</tbody>
                </table>
            </div>
        </div>`;
}

function uRow(u) {
    const st = u.role === 'admin' ? 'background:rgba(99,102,241,0.2);color:#6366f1' : 'background:rgba(6,182,212,0.2);color:#06b6d4';
    return `<tr style="border-bottom:1px solid rgba(99,102,241,0.2);">
        <td style="padding:12px;"><strong>${u.firstName||''} ${u.lastName||''}</strong></td>
        <td style="padding:12px;">${u.email}</td>
        <td style="padding:12px;"><span style="padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:600;${st}">${u.role}</span></td>
        <td style="padding:12px;">${new Date(u.createdAt).toLocaleDateString()}</td>
        <td style="padding:12px;"><button onclick="toggleRole('${u._id}','${u.role}')" style="padding:6px 12px;background:linear-gradient(135deg,#8b5cf6,#6366f1);border:none;border-radius:6px;color:#fff;cursor:pointer;">${u.role === 'admin' ? 'üë§ Make User' : 'üëë Make Admin'}</button></td>
    </tr>`;
}

function filterU(v) { renderUsers(v === 'all' ? allU : allU.filter(u => u.role === v)); }
function searchU(t) { renderUsers(allU.filter(u => (u.email||'').toLowerCase().includes(t.toLowerCase()) || (u.firstName||'').toLowerCase().includes(t.toLowerCase()))); }
</script>
<script>
// Approve purchase
async function approve(id) {
    if (!confirm('Approve this purchase?')) return;
    try {
        const r = await fetch(API + '/admin/purchases/' + id + '/approve', {
            method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token }
        });
        if (r.ok) { alert('‚úÖ Purchase approved!'); loadAll(); }
        else { const d = await r.json(); alert('‚ùå ' + (d.message || 'Error')); }
    } catch { alert('‚ùå Error approving'); }
}

// Reject purchase
async function reject(id) {
    const reason = prompt('Rejection reason (optional):');
    if (reason === null) return;
    try {
        const r = await fetch(API + '/admin/purchases/' + id + '/reject', {
            method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ reason })
        });
        if (r.ok) { alert('‚úÖ Purchase rejected'); loadAll(); }
        else { const d = await r.json(); alert('‚ùå ' + (d.message || 'Error')); }
    } catch { alert('‚ùå Error rejecting'); }
}

// Toggle user role
async function toggleRole(id, role) {
    const newRole = role === 'admin' ? 'user' : 'admin';
    if (!confirm('Change role to ' + newRole + '?')) return;
    try {
        const r = await fetch(API + '/admin/users/' + id + '/role', {
            method: 'PUT', headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({ role: newRole })
        });
        if (r.ok) { alert('‚úÖ Role changed to ' + newRole); loadUsers(); }
        else { const d = await r.json(); alert('‚ùå ' + (d.message || 'Error')); }
    } catch { alert('‚ùå Error changing role'); }
}

// View purchase modal
function viewP(id) {
    const p = [...pendP, ...allP].find(x => x._id === id);
    if (!p) return alert('Not found');
    const st = p.status === 'pending' ? 'background:rgba(251,191,36,0.2);color:#fbbf24' : p.status === 'approved' ? 'background:rgba(34,197,94,0.2);color:#22c55e' : 'background:rgba(239,68,68,0.2);color:#ef4444';
    document.getElementById('modalC').innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3>üìã Purchase Details</h3>
            <button onclick="closeModal()" style="background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;">&times;</button>
        </div>
        <div style="line-height:2;">
            <p><strong>Order ID:</strong> ${p.orderId||'N/A'}</p>
            <p><strong>User:</strong> ${p.user?.firstName||''} ${p.user?.lastName||''}</p>
            <p><strong>Email:</strong> ${p.user?.email||p.userEmail||'N/A'}</p>
            <p><strong>Course:</strong> ${p.course?.title||'N/A'}</p>
            <p><strong>Amount:</strong> $${p.amount||0}</p>
            <p><strong>Status:</strong> <span style="padding:4px 12px;border-radius:20px;font-size:0.8rem;${st}">${p.status}</span></p>
            <p><strong>Created:</strong> ${new Date(p.createdAt).toLocaleString()}</p>
            ${p.verifiedAt ? '<p><strong>Verified:</strong> ' + new Date(p.verifiedAt).toLocaleString() + '</p>' : ''}
            ${p.rejectionReason ? '<p><strong>Reason:</strong> ' + p.rejectionReason + '</p>' : ''}
        </div>
        ${p.status === 'pending' ? `<div style="margin-top:20px;display:flex;gap:10px;">
            <button onclick="approve('${p._id}');closeModal();" style="padding:10px 20px;background:linear-gradient(135deg,#22c55e,#10b981);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;">‚úì Approve</button>
            <button onclick="reject('${p._id}');closeModal();" style="padding:10px 20px;background:linear-gradient(135deg,#ef4444,#dc2626);border:none;border-radius:8px;color:#fff;cursor:pointer;font-weight:600;">‚úó Reject</button>
        </div>` : ''}
    `;
    document.getElementById('modal').style.display = 'block';
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }

// Init
window.onload = async () => {
    await checkConn();
    if (token && connected) await verifyToken();
};

// Auto-refresh every 30s
setInterval(() => { if (token && connected) loadAll(); }, 30000);
setInterval(checkConn, 10000);

document.onkeydown = (e) => { if (e.key === 'Escape') closeModal(); };
console.log('üéØ BullBear Admin Dashboard Ready');
</script>