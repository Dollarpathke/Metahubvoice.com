<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BullBear Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-primary: #050508;
            --bg-secondary: #0c0c12;
            --bg-card: #111118;
            --bg-hover: #1a1a24;
            --bg-glass: rgba(17, 17, 24, 0.7);
            --border-color: rgba(139, 92, 246, 0.12);
            --border-hover: rgba(139, 92, 246, 0.35);
            --border-glow: rgba(139, 92, 246, 0.5);
            --text-primary: #f4f4f5;
            --text-secondary: #a1a1aa;
            --text-muted: #71717a;
            --accent-primary: #8b5cf6;
            --accent-secondary: #a78bfa;
            --accent-tertiary: #c4b5fd;
            --accent-gold: #fbbf24;
            --accent-cyan: #22d3ee;
            --accent-pink: #f472b6;
            --success: #34d399;
            --warning: #fbbf24;
            --danger: #f87171;
            --sidebar-width: 280px;
            --glow-primary: 0 0 20px rgba(139, 92, 246, 0.3);
            --glow-success: 0 0 20px rgba(52, 211, 153, 0.3);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            min-height: 100vh;
            font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            letter-spacing: -0.01em;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(139, 92, 246, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 0%, rgba(34, 211, 238, 0.08), transparent);
            pointer-events: none;
            z-index: 0;
        }
        .sidebar { position: fixed; left: 0; top: 0; width: var(--sidebar-width); height: 100vh; background: var(--bg-secondary); border-right: 1px solid var(--border-color); padding: 24px 16px; display: flex; flex-direction: column; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 12px; padding: 0 12px 24px; border-bottom: 1px solid var(--border-color); margin-bottom: 24px; }
        .logo-icon { width: 40px; height: 40px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .logo-text { font-size: 1.1rem; font-weight: 700; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .nav-section { margin-bottom: 24px; }
        .nav-label { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); padding: 0 12px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-radius: 10px; color: var(--text-secondary); cursor: pointer; transition: all 0.2s ease; margin-bottom: 4px; }
        .nav-item:hover, .nav-item.active { background: var(--bg-hover); color: var(--text-primary); }
        .nav-item.active { background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(6, 182, 212, 0.1)); border: 1px solid var(--border-hover); }
        .nav-item i { width: 20px; text-align: center; }
        .nav-badge { margin-left: auto; background: var(--danger); color: white; font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 10px; }
        .sidebar-footer { margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border-color); }
        .main { margin-left: var(--sidebar-width); min-height: 100vh; }
        .topbar { position: sticky; top: 0; background: rgba(10, 10, 15, 0.9); backdrop-filter: blur(20px); border-bottom: 1px solid var(--border-color); padding: 16px 32px; display: flex; align-items: center; justify-content: space-between; z-index: 50; }
        .page-title { font-size: 1.4rem; font-weight: 600; }
        .status-badge { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 20px; font-size: 0.8rem; color: var(--success); }
        .status-badge.error { background: rgba(239, 68, 68, 0.1); border-color: rgba(239, 68, 68, 0.3); color: var(--danger); }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: currentColor; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .content { padding: 32px; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; padding: 24px; transition: all 0.3s ease; }
        .stat-card:hover { border-color: var(--border-hover); transform: translateY(-2px); }
        .stat-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
        .stat-icon { width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
        .stat-icon.revenue { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .stat-icon.users { background: rgba(99, 102, 241, 0.15); color: var(--accent-primary); }
        .stat-icon.purchases { background: rgba(6, 182, 212, 0.15); color: var(--accent-cyan); }
        .stat-icon.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .stat-trend { display: flex; align-items: center; gap: 4px; font-size: 0.75rem; font-weight: 500; padding: 4px 8px; border-radius: 6px; background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); }
        .data-section { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 16px; margin-bottom: 24px; overflow: hidden; }
        .section-header { display: flex; align-items: center; justify-content: space-between; padding: 20px 24px; border-bottom: 1px solid var(--border-color); flex-wrap: wrap; gap: 16px; }
        .section-title { display: flex; align-items: center; gap: 12px; font-size: 1.1rem; font-weight: 600; }
        .section-title i { color: var(--accent-primary); }
        .section-count { background: var(--bg-hover); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; color: var(--text-secondary); }
        .section-actions { display: flex; gap: 12px; align-items: center; }
        .search-box { display: flex; align-items: center; gap: 8px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 8px 16px; }
        .search-box input { background: none; border: none; outline: none; color: var(--text-primary); font-size: 0.85rem; width: 150px; }
        .filter-select { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; padding: 8px 16px; color: var(--text-primary); font-size: 0.85rem; cursor: pointer; outline: none; }
        .filter-select option { background: var(--bg-secondary); }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 16px 24px; text-align: left; border-bottom: 1px solid var(--border-color); }
        th { background: var(--bg-secondary); font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: var(--text-muted); }
        tr:hover { background: var(--bg-hover); }
        .user-cell { display: flex; align-items: center; gap: 12px; }
        .user-avatar { width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 600; }
        .user-name { font-weight: 600; font-size: 0.9rem; }
        .user-email { font-size: 0.8rem; color: var(--text-muted); }
        .status-pill { display: inline-flex; padding: 6px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 600; }
        .status-pill.pending { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .status-pill.approved, .status-pill.completed { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .status-pill.rejected { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .status-pill.admin { background: rgba(139, 92, 246, 0.15); color: var(--accent-secondary); }
        .status-pill.user { background: rgba(6, 182, 212, 0.15); color: var(--accent-cyan); }
        .action-btns { display: flex; gap: 8px; }
        .action-btn { width: 32px; height: 32px; border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; transition: all 0.2s ease; }
        .action-btn:hover { transform: scale(1.1); }
        .action-btn.approve { background: rgba(16, 185, 129, 0.15); color: var(--success); }
        .action-btn.approve:hover { background: var(--success); color: white; }
        .action-btn.reject { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .action-btn.reject:hover { background: var(--danger); color: white; }
        .action-btn.view { background: rgba(6, 182, 212, 0.15); color: var(--accent-cyan); }
        .action-btn.view:hover { background: var(--accent-cyan); color: white; }
        .action-btn.role { background: rgba(139, 92, 246, 0.15); color: var(--accent-secondary); }
        .action-btn.role:hover { background: var(--accent-secondary); color: white; }
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state i { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
        .loading-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-primary); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 300; }
        .loading-overlay.hidden { display: none; }
        .loader { width: 60px; height: 60px; border: 3px solid var(--border-color); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 24px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast-container { position: fixed; bottom: 24px; right: 24px; z-index: 400; }
        .toast { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: 12px; padding: 16px 20px; display: flex; align-items: center; gap: 12px; margin-top: 12px; animation: toastIn 0.3s ease; }
        @keyframes toastIn { from { opacity: 0; transform: translateX(100px); } to { opacity: 1; transform: translateX(0); } }
        .toast.success { border-left: 4px solid var(--success); }
        .toast.error { border-left: 4px solid var(--danger); }
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
        .form-group { display: flex; flex-direction: column; gap: 8px; }
        .form-group label { font-size: 0.85rem; font-weight: 500; color: var(--text-secondary); }
        .form-input { padding: 12px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; color: var(--text-primary); font-size: 0.9rem; outline: none; }
        .form-input:focus { border-color: var(--accent-primary); }
        .save-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); border: none; border-radius: 10px; color: white; font-size: 0.9rem; font-weight: 600; cursor: pointer; }
        .save-btn:hover { transform: translateY(-2px); }
        .save-btn.secondary { background: var(--bg-hover); border: 1px solid var(--border-color); }
        .danger-btn { padding: 10px 20px; background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; color: var(--danger); font-weight: 600; cursor: pointer; }
        .danger-btn:hover { background: var(--danger); color: white; }
        .toggle-switch { position: relative; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-hover); border-radius: 26px; transition: 0.3s; }
        .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
        .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, var(--accent-primary), var(--accent-cyan)); }
        .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
        .setting-item { display: flex; align-items: center; justify-content: space-between; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .setting-item:last-child { border-bottom: none; }
        @media (max-width: 1200px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 768px) { .sidebar { display: none; } .main { margin-left: 0; } .stats-grid { grid-template-columns: 1fr; } .form-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loader"></div>
        <p style="color: var(--text-secondary);">Connecting to server...</p>
    </div>

    <aside class="sidebar">
        <div class="logo">
            <img src="images/bullbear-logo.png" alt="BullBear" style="width: 40px; height: 40px; border-radius: 10px; object-fit: contain;">
            <span class="logo-text">BullBear Admin</span>
        </div>
        <nav class="nav-section">
            <div class="nav-label">Overview</div>
            <div class="nav-item active" onclick="navigate('dashboard')"><i class="fas fa-chart-pie"></i><span>Dashboard</span></div>
        </nav>
        <nav class="nav-section">
            <div class="nav-label">Management</div>
            <div class="nav-item" onclick="navigate('pending')"><i class="fas fa-clock"></i><span>Pending</span><span id="pendingBadge" class="nav-badge" style="display:none">0</span></div>
            <div class="nav-item" onclick="navigate('purchases')"><i class="fas fa-shopping-cart"></i><span>Purchases</span></div>
            <div class="nav-item" onclick="navigate('users')"><i class="fas fa-users"></i><span>Users</span></div>
        </nav>
        <nav class="nav-section">
            <div class="nav-label">Insights</div>
            <div class="nav-item" onclick="navigate('analytics')"><i class="fas fa-chart-line"></i><span>Analytics</span></div>
        </nav>
        <nav class="nav-section">
            <div class="nav-label">Account</div>
            <div class="nav-item" onclick="navigate('profile')"><i class="fas fa-user-circle"></i><span>Profile</span></div>
            <div class="nav-item" onclick="navigate('settings')"><i class="fas fa-cog"></i><span>Settings</span></div>
        </nav>
        <div class="sidebar-footer">
            <div class="nav-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
        </div>
    </aside>

    <main class="main">
        <header class="topbar">
            <h1 class="page-title" id="pageTitle">Dashboard</h1>
            <div id="statusBadge" class="status-badge"><span class="status-dot"></span><span>Connected</span></div>
        </header>
        <div class="content" id="content"></div>
    </main>

    <div class="toast-container" id="toastContainer"></div>

    <script>
const API = 'http://localhost:5000/api';
let TOKEN = null, allPurchases = [], pendingPurchases = [], allUsers = [];

async function init() {
    try {
        const h = await fetch(API + '/health');
        if (!h.ok) throw new Error('Server offline');
        
        const r = await fetch(API + '/admin/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email: 'admin@bullbeartrading.com', password: 'Admin@2025!' })
        });
        const d = await r.json();
        if (!r.ok) throw new Error(d.message || 'Login failed');
        
        TOKEN = d.data.token;
        document.getElementById('loadingOverlay').classList.add('hidden');
        navigate('dashboard');
        setInterval(loadData, 30000);
    } catch (e) {
        document.getElementById('loadingOverlay').innerHTML = '<i class="fas fa-exclamation-triangle" style="font-size:3rem;color:var(--danger);margin-bottom:20px"></i><p style="color:var(--danger)">' + e.message + '</p><p style="color:var(--text-muted);margin-top:8px">Make sure backend is running on port 5000</p>';
        document.getElementById('statusBadge').className = 'status-badge error';
        document.getElementById('statusBadge').innerHTML = '<span class="status-dot"></span><span>Disconnected</span>';
    }
}

async function loadData() {
    try {
        console.log('Loading data with token:', TOKEN ? 'present' : 'missing');
        const [statsRes, pendRes, purchRes, usersRes] = await Promise.all([
            fetch(API + '/admin/stats', { headers: { Authorization: 'Bearer ' + TOKEN } }),
            fetch(API + '/admin/purchases?status=pending', { headers: { Authorization: 'Bearer ' + TOKEN } }),
            fetch(API + '/admin/purchases', { headers: { Authorization: 'Bearer ' + TOKEN } }),
            fetch(API + '/admin/users', { headers: { Authorization: 'Bearer ' + TOKEN } })
        ]);
        
        const statsData = await statsRes.json();
        const pendData = await pendRes.json();
        const purchData = await purchRes.json();
        const usersData = await usersRes.json();
        
        console.log('Stats response:', statsData);
        console.log('Pending response:', pendData);
        console.log('Purchases response:', purchData);
        console.log('Users response:', usersData);
        
        const stats = statsData.data || {};
        pendingPurchases = pendData.data?.purchases || [];
        allPurchases = purchData.data?.purchases || [];
        allUsers = usersData.data?.users || [];
        
        console.log('Parsed - Users:', allUsers.length, 'Purchases:', allPurchases.length);
        
        const badge = document.getElementById('pendingBadge');
        if (pendingPurchases.length > 0) { badge.style.display = 'block'; badge.textContent = pendingPurchases.length; }
        else { badge.style.display = 'none'; }
        
        return stats;
    } catch (e) { console.error('loadData error:', e); return {}; }
}

function navigate(page) {
    document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
    event?.target?.closest('.nav-item')?.classList.add('active');
    document.getElementById('pageTitle').textContent = page.charAt(0).toUpperCase() + page.slice(1);
    
    switch(page) {
        case 'dashboard': renderDashboard(); break;
        case 'pending': renderPendingPage(); break;
        case 'purchases': renderPurchasesPage(); break;
        case 'users': renderUsersPage(); break;
        case 'analytics': renderAnalytics(); break;
        case 'profile': renderProfile(); break;
        case 'settings': renderSettings(); break;
        default: renderDashboard();
    }
}

async function renderPendingPage() {
    await loadData();
    document.getElementById('content').innerHTML = `
        <div class="data-section">
            <div class="section-header"><div class="section-title"><i class="fas fa-clock"></i>Pending Approvals<span class="section-count">${pendingPurchases.length}</span></div></div>
            <div id="pendingTable"></div>
        </div>
    `;
    renderTable('pendingTable', pendingPurchases, true);
}

async function renderPurchasesPage() {
    await loadData();
    document.getElementById('content').innerHTML = `
        <div class="data-section">
            <div class="section-header"><div class="section-title"><i class="fas fa-shopping-cart"></i>All Purchases<span class="section-count">${allPurchases.length}</span></div>
            <div class="section-actions"><select class="filter-select" onchange="filterPurchases(this.value)"><option value="all">All</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select></div></div>
            <div id="purchasesTable"></div>
        </div>
    `;
    renderTable('purchasesTable', allPurchases, false);
}

async function renderUsersPage() {
    await loadData();
    document.getElementById('content').innerHTML = `
        <div class="data-section">
            <div class="section-header"><div class="section-title"><i class="fas fa-users"></i>All Users<span class="section-count">${allUsers.length}</span></div></div>
            <div id="usersTable"></div>
        </div>
    `;
    renderUsersTable();
}

async function renderDashboard() {
    const stats = await loadData();
    document.getElementById('content').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-header"><div class="stat-icon revenue"><i class="fas fa-dollar-sign"></i></div><div class="stat-trend"><i class="fas fa-arrow-up"></i> 12%</div></div><div class="stat-value">$${stats.totalRevenue || 0}</div><div class="stat-label">Total Revenue</div></div>
            <div class="stat-card"><div class="stat-header"><div class="stat-icon users"><i class="fas fa-users"></i></div><div class="stat-trend"><i class="fas fa-arrow-up"></i> 8%</div></div><div class="stat-value">${stats.totalUsers || 0}</div><div class="stat-label">Total Users</div></div>
            <div class="stat-card"><div class="stat-header"><div class="stat-icon purchases"><i class="fas fa-shopping-bag"></i></div><div class="stat-trend"><i class="fas fa-arrow-up"></i> 15%</div></div><div class="stat-value">${stats.totalPurchases || 0}</div><div class="stat-label">Total Purchases</div></div>
            <div class="stat-card"><div class="stat-header"><div class="stat-icon pending"><i class="fas fa-clock"></i></div></div><div class="stat-value">${stats.pendingApprovals || 0}</div><div class="stat-label">Pending Approvals</div></div>
        </div>
        <div class="data-section">
            <div class="section-header"><div class="section-title"><i class="fas fa-clock"></i>Pending Approvals<span class="section-count">${pendingPurchases.length}</span></div></div>
            <div id="pendingTable"></div>
        </div>
        <div class="data-section">
            <div class="section-header"><div class="section-title"><i class="fas fa-shopping-cart"></i>All Purchases<span class="section-count">${allPurchases.length}</span></div>
            <div class="section-actions"><select class="filter-select" onchange="filterPurchases(this.value)"><option value="all">All</option><option value="pending">Pending</option><option value="approved">Approved</option><option value="rejected">Rejected</option></select></div></div>
            <div id="purchasesTable"></div>
        </div>
        <div class="data-section">
            <div class="section-header"><div class="section-title"><i class="fas fa-users"></i>Users<span class="section-count">${allUsers.length}</span></div></div>
            <div id="usersTable"></div>
        </div>
    `;
    renderTable('pendingTable', pendingPurchases, true);
    renderTable('purchasesTable', allPurchases, false);
    renderUsersTable();
}

function renderTable(id, list, isPending) {
    if (list.length === 0) {
        document.getElementById(id).innerHTML = '<div class="empty-state"><i class="fas fa-check-circle"></i><p>No items</p></div>';
        return;
    }
    let html = '<table><thead><tr><th>Order</th><th>Customer</th><th>Course</th><th>Amount</th><th>Date</th>' + (isPending ? '' : '<th>Status</th>') + '<th>Actions</th></tr></thead><tbody>';
    list.forEach(p => {
        html += '<tr><td><strong>' + (p.orderId || '-') + '</strong></td>';
        html += '<td><div class="user-cell"><div class="user-avatar">' + ((p.user?.firstName?.[0] || 'U').toUpperCase()) + '</div><div><div class="user-name">' + (p.user?.firstName || '') + ' ' + (p.user?.lastName || '') + '</div><div class="user-email">' + (p.user?.email || p.userEmail || '') + '</div></div></div></td>';
        html += '<td>' + (p.course?.title || '-') + '</td>';
        html += '<td><strong>$' + (p.amount || 0) + '</strong></td>';
        html += '<td>' + new Date(p.createdAt).toLocaleDateString() + '</td>';
        if (!isPending) html += '<td><span class="status-pill ' + p.status + '">' + p.status + '</span></td>';
        html += '<td><div class="action-btns">';
        if (p.status === 'pending') {
            html += '<button class="action-btn approve" onclick="approve(\'' + p._id + '\')"><i class="fas fa-check"></i></button>';
            html += '<button class="action-btn reject" onclick="reject(\'' + p._id + '\')"><i class="fas fa-times"></i></button>';
        }
        html += '</div></td></tr>';
    });
    html += '</tbody></table>';
    document.getElementById(id).innerHTML = html;
}

function renderUsersTable() {
    if (allUsers.length === 0) {
        document.getElementById('usersTable').innerHTML = '<div class="empty-state"><i class="fas fa-users"></i><p>No users</p></div>';
        return;
    }
    let html = '<table><thead><tr><th>User</th><th>Email</th><th>Role</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
    allUsers.forEach(u => {
        html += '<tr><td><div class="user-cell"><div class="user-avatar">' + ((u.firstName?.[0] || 'U').toUpperCase()) + '</div><div class="user-name">' + (u.firstName || '') + ' ' + (u.lastName || '') + '</div></div></td>';
        html += '<td>' + u.email + '</td>';
        html += '<td><span class="status-pill ' + u.role + '">' + u.role + '</span></td>';
        html += '<td>' + new Date(u.createdAt).toLocaleDateString() + '</td>';
        html += '<td><button class="action-btn role" onclick="toggleRole(\'' + u._id + '\',\'' + u.role + '\')"><i class="fas fa-' + (u.role === 'admin' ? 'user' : 'crown') + '"></i></button></td></tr>';
    });
    html += '</tbody></table>';
    document.getElementById('usersTable').innerHTML = html;
}

function filterPurchases(status) {
    const filtered = status === 'all' ? allPurchases : allPurchases.filter(p => p.status === status);
    renderTable('purchasesTable', filtered, false);
}

async function approve(id) {
    if (!confirm('Approve this purchase?')) return;
    try {
        const r = await fetch(API + '/admin/purchases/' + id + '/approve', { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + TOKEN } });
        if (r.ok) { showToast('Approved!', 'success'); renderDashboard(); }
        else { showToast('Failed', 'error'); }
    } catch (e) { showToast('Error', 'error'); }
}

async function reject(id) {
    const reason = prompt('Reason (optional):');
    if (reason === null) return;
    try {
        const r = await fetch(API + '/admin/purchases/' + id + '/reject', { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + TOKEN }, body: JSON.stringify({ reason }) });
        if (r.ok) { showToast('Rejected', 'success'); renderDashboard(); }
        else { showToast('Failed', 'error'); }
    } catch (e) { showToast('Error', 'error'); }
}

async function toggleRole(id, role) {
    const newRole = role === 'admin' ? 'user' : 'admin';
    if (!confirm('Change to ' + newRole + '?')) return;
    try {
        const r = await fetch(API + '/admin/users/' + id + '/role', { method: 'PUT', headers: { 'Content-Type': 'application/json', Authorization: 'Bearer ' + TOKEN }, body: JSON.stringify({ role: newRole }) });
        if (r.ok) { showToast('Role changed', 'success'); renderDashboard(); }
        else { showToast('Failed', 'error'); }
    } catch (e) { showToast('Error', 'error'); }
}

function renderAnalytics() {
    document.getElementById('content').innerHTML = `
        <div class="stats-grid">
            <div class="stat-card"><div class="stat-header"><div class="stat-icon revenue"><i class="fas fa-chart-line"></i></div><div class="stat-trend"><i class="fas fa-arrow-up"></i> 24%</div></div><div class="stat-value">$${Math.floor(Math.random()*10000)}</div><div class="stat-label">This Month</div></div>
            <div class="stat-card"><div class="stat-header"><div class="stat-icon users"><i class="fas fa-user-plus"></i></div><div class="stat-trend"><i class="fas fa-arrow-up"></i> 18%</div></div><div class="stat-value">${Math.floor(Math.random()*100)}</div><div class="stat-label">New Users</div></div>
            <div class="stat-card"><div class="stat-header"><div class="stat-icon purchases"><i class="fas fa-percentage"></i></div></div><div class="stat-value">${(Math.random()*10+2).toFixed(1)}%</div><div class="stat-label">Conversion</div></div>
            <div class="stat-card"><div class="stat-header"><div class="stat-icon pending"><i class="fas fa-eye"></i></div></div><div class="stat-value">${Math.floor(Math.random()*5000)}</div><div class="stat-label">Page Views</div></div>
        </div>
        <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-chart-bar"></i>Revenue Chart</div></div>
        <div style="padding:24px;display:flex;align-items:flex-end;gap:12px;height:250px;">
            ${['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].map(() => '<div style="flex:1;background:linear-gradient(180deg,var(--accent-primary),var(--accent-cyan));border-radius:6px 6px 0 0;height:' + (Math.random()*150+50) + 'px;"></div>').join('')}
        </div></div>
        <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-fire"></i>Top Courses</div></div>
        <div style="padding:16px;">
            <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color);"><span>Crypto Trading Masterclass</span><strong style="color:var(--success)">$4,455</strong></div>
            <div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border-color);"><span>Blockchain Fundamentals</span><strong style="color:var(--success)">$1,568</strong></div>
            <div style="display:flex;justify-content:space-between;padding:12px 0;"><span>DeFi Strategies</span><strong style="color:var(--success)">$2,772</strong></div>
        </div></div>
    `;
}

function renderProfile() {
    document.getElementById('content').innerHTML = `
        <div style="max-width:800px;">
            <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-user"></i>Profile</div></div>
            <div style="padding:24px;">
                <div style="display:flex;align-items:center;gap:24px;margin-bottom:32px;">
                    <div style="width:100px;height:100px;background:linear-gradient(135deg,var(--accent-primary),var(--accent-secondary));border-radius:20px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:700;">A</div>
                    <div><h2 style="margin-bottom:4px;">Admin User</h2><p style="color:var(--text-muted);">admin@bullbeartrading.com</p><span class="status-pill admin" style="margin-top:8px;display:inline-block;">Administrator</span></div>
                </div>
                <div class="form-grid">
                    <div class="form-group"><label>First Name</label><input type="text" value="Admin" class="form-input"></div>
                    <div class="form-group"><label>Last Name</label><input type="text" value="User" class="form-input"></div>
                    <div class="form-group"><label>Email</label><input type="email" value="admin@bullbeartrading.com" class="form-input"></div>
                    <div class="form-group"><label>Phone</label><input type="tel" value="+1 234 567 8900" class="form-input"></div>
                </div>
                <button class="save-btn" onclick="showToast('Profile saved!','success')"><i class="fas fa-save"></i> Save</button>
            </div></div>
            <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-lock"></i>Password</div></div>
            <div style="padding:24px;">
                <div class="form-grid">
                    <div class="form-group"><label>Current Password</label><input type="password" class="form-input" placeholder="Current password"></div>
                    <div class="form-group"><label>New Password</label><input type="password" class="form-input" placeholder="New password"></div>
                </div>
                <button class="save-btn" onclick="showToast('Password updated!','success')"><i class="fas fa-key"></i> Update</button>
            </div></div>
        </div>
    `;
}

function renderSettings() {
    document.getElementById('content').innerHTML = `
        <div style="max-width:800px;">
            <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-globe"></i>General</div></div>
            <div style="padding:24px;">
                <div class="form-grid">
                    <div class="form-group"><label>Site Name</label><input type="text" value="BullBear Trading" class="form-input"></div>
                    <div class="form-group"><label>Site URL</label><input type="url" value="https://bullbeartrading.com" class="form-input"></div>
                    <div class="form-group"><label>Support Email</label><input type="email" value="support@bullbeartrading.com" class="form-input"></div>
                    <div class="form-group"><label>Timezone</label><select class="form-input"><option>UTC</option><option selected>America/New_York</option></select></div>
                </div>
                <button class="save-btn" onclick="showToast('Settings saved!','success')"><i class="fas fa-save"></i> Save</button>
            </div></div>
            <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-bell"></i>Notifications</div></div>
            <div style="padding:24px;">
                <div class="setting-item"><div><h4>Email Notifications</h4><p style="color:var(--text-muted);font-size:0.85rem;">Receive alerts for new purchases</p></div><label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label></div>
                <div class="setting-item"><div><h4>New User Alerts</h4><p style="color:var(--text-muted);font-size:0.85rem;">Get notified for new registrations</p></div><label class="toggle-switch"><input type="checkbox" checked><span class="toggle-slider"></span></label></div>
                <div class="setting-item"><div><h4>Weekly Reports</h4><p style="color:var(--text-muted);font-size:0.85rem;">Receive weekly analytics</p></div><label class="toggle-switch"><input type="checkbox"><span class="toggle-slider"></span></label></div>
            </div></div>
            <div class="data-section"><div class="section-header"><div class="section-title"><i class="fas fa-credit-card"></i>Payment</div></div>
            <div style="padding:24px;">
                <div class="form-grid">
                    <div class="form-group"><label>PayPal Client ID</label><input type="text" value="••••••••••••" class="form-input"></div>
                    <div class="form-group"><label>PayPal Secret</label><input type="password" value="••••••••••••" class="form-input"></div>
                </div>
                <button class="save-btn" onclick="showToast('Payment settings saved!','success')"><i class="fas fa-save"></i> Save</button>
            </div></div>
            <div class="data-section" style="border-color:rgba(239,68,68,0.3);"><div class="section-header"><div class="section-title" style="color:var(--danger);"><i class="fas fa-exclamation-triangle"></i>Danger Zone</div></div>
            <div style="padding:24px;display:flex;justify-content:space-between;align-items:center;">
                <div><h4 style="color:var(--danger);">Clear All Data</h4><p style="color:var(--text-muted);font-size:0.85rem;">Permanently delete all data</p></div>
                <button class="danger-btn" onclick="if(confirm('Are you sure?'))showToast('Data cleared','error')"><i class="fas fa-trash"></i> Clear</button>
            </div></div>
        </div>
    `;
}

function showToast(msg, type) {
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + '" style="color:var(--' + type + ')"></i><span>' + msg + '</span>';
    document.getElementById('toastContainer').appendChild(t);
    setTimeout(() => t.remove(), 3000);
}

function logout() { location.reload(); }

init();
    </script>
</body>
</html>
